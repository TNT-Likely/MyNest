name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mynest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Ensure tags are fetched
        run: |
          git fetch --tags --force || true

      - name: Debug secrets (safe)
        run: |
          echo "Username length: ${#DOCKERHUB_USERNAME}"
          echo "Token length: ${#DOCKERHUB_TOKEN}"
          echo "Username starts with: ${DOCKERHUB_USERNAME:0:3}..."
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push MyNest All-in-One image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ steps.meta.outputs.version }}"
          # èŽ·å–ä¸Šä¸€ä¸ª tagï¼ˆä¸å«å½“å‰ tagï¼‰
          PREV_TAG=$(git tag --list --sort=-version:refname | grep -v "^v${TAG}$" | head -n1)
          echo "Current tag: v$TAG"
          echo "Previous tag: $PREV_TAG"

          # ç”Ÿæˆ commit åˆ—è¡¨ï¼ˆæŽ’é™¤ merge commitï¼‰
          if [ -n "$PREV_TAG" ]; then
            echo "Generating commit log from $PREV_TAG to HEAD"
            COMMITS=$(git log --no-merges --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" "$PREV_TAG"..HEAD)
          else
            echo "No previous tag found, showing all commits"
            COMMITS=$(git log --no-merges --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))")
          fi

          cat > RELEASE_NOTES.md <<EOF
          ## ðŸš€ Docker Image

          **MyNest All-in-Oneï¼ˆå‰ç«¯ + åŽç«¯ + æ‰€æœ‰æ’ä»¶ï¼‰:**
          \`\`\`bash
          docker pull ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          \`\`\`

          ## ðŸ“¦ å¿«é€Ÿéƒ¨ç½²

          \`\`\`bash
          # ä¸‹è½½é…ç½®æ–‡ä»¶
          wget https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
          wget https://raw.githubusercontent.com/${{ github.repository }}/main/.env.example -O .env

          # ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹å¯†ç ç­‰ï¼‰
          nano .env

          # å¯åŠ¨æœåŠ¡
          docker-compose up -d
          \`\`\`

          ## ðŸ”— è®¿é—®åº”ç”¨

          - Web ç•Œé¢: http://localhost:3000
          - è‡ªåŠ¨ä»£ç†å‰åŽç«¯ï¼Œæ— éœ€å•ç‹¬è®¿é—®åŽç«¯ API
          - å¥åº·æ£€æŸ¥: http://localhost:3000/health

          ## âœ¨ æž¶æž„ç‰¹ç‚¹

          - **ä¸€ä¸ªé•œåƒåŒ…å«æ‰€æœ‰æœåŠ¡**ï¼šNginx + React å‰ç«¯ + Go åŽç«¯ + æ’ä»¶
          - **å•ç«¯å£è®¿é—®**ï¼šåªéœ€æš´éœ² 3000 ç«¯å£
          - **è‡ªåŠ¨ä»£ç†**ï¼šNginx å¤„ç† \`/api/*\` åˆ°åŽç«¯çš„ä»£ç†
          - **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«æ—¥å¿—ã€å¥åº·æ£€æŸ¥ã€è¿›ç¨‹ç®¡ç†

          ## ðŸ“ å˜æ›´è®°å½•

          $COMMITS

          ---

          å®Œæ•´æ–‡æ¡£: https://github.com/${{ github.repository }}/blob/main/README.md
          EOF

          echo "notes_file=RELEASE_NOTES.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: ${{ steps.notes.outputs.notes_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}