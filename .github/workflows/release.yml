name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mynest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push MyNest All-in-One image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## ğŸš€ Docker Image

            **MyNest All-in-Oneï¼ˆå‰ç«¯ + åç«¯ + æ‰€æœ‰æ’ä»¶ï¼‰:**
            ```bash
            docker pull ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ```

            ## ğŸ“¦ å¿«é€Ÿéƒ¨ç½²

            ```bash
            # ä¸‹è½½é…ç½®æ–‡ä»¶
            wget https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
            wget https://raw.githubusercontent.com/${{ github.repository }}/main/.env.example -O .env

            # ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹å¯†ç ç­‰ï¼‰
            nano .env

            # å¯åŠ¨æœåŠ¡
            docker-compose up -d
            ```

            ## ğŸ”— è®¿é—®åº”ç”¨

            - Web ç•Œé¢: http://localhost:3000
            - è‡ªåŠ¨ä»£ç†å‰åç«¯ï¼Œæ— éœ€å•ç‹¬è®¿é—®åç«¯ API
            - å¥åº·æ£€æŸ¥: http://localhost:3000/health

            ## âœ¨ æ¶æ„ç‰¹ç‚¹

            - **ä¸€ä¸ªé•œåƒåŒ…å«æ‰€æœ‰æœåŠ¡**ï¼šNginx + React å‰ç«¯ + Go åç«¯ + æ’ä»¶
            - **å•ç«¯å£è®¿é—®**ï¼šåªéœ€æš´éœ² 3000 ç«¯å£
            - **è‡ªåŠ¨ä»£ç†**ï¼šNginx å¤„ç† `/api/*` åˆ°åç«¯çš„ä»£ç†
            - **ç”Ÿäº§å°±ç»ª**ï¼šåŒ…å«æ—¥å¿—ã€å¥åº·æ£€æŸ¥ã€è¿›ç¨‹ç®¡ç†

            å®Œæ•´æ–‡æ¡£: https://github.com/${{ github.repository }}/blob/main/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}